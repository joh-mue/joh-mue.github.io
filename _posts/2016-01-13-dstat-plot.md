---
layout: post
title:  "Dstat-Plot!"
date:   2016-01-13 01:01:00 +0100
categories: tech
---

## dstat monitor plotting script

This ruby script uses GNUPlot through a ruby wrapper [(ruby_gnuplot)](https://github.com/rdp/ruby_gnuplot/blob/master/README.textile) to plot csv data generated by mvneves' [dstat-monitor](https://github.com/mvneves/dstat-monitor).

### Pre-requisites and Installation

You need an installation of the ruby programming language, X11, GNUPlot and the ruby_gnuplot gem. The gems csv and optparse are part of the ruby standard library.

To install on a Mac do the following steps:

```
    1. Install XQuartz from here:
        http://xquartz.macosforge.org/landing/
    2. Install gnuplot with homebrew:
        brew install gnuplot --with-x11
    3. Install gnuplot gem:
        gem install gnuplot
```

For linux the procedure is

```
1. Install gnuplot (your distribution might come with it though)
    sudo apt-get install gnuplot
2. Install gnuplot gem:
    gem install gnuplot
3. Install csv gem
    gem install fastercsv
```

### Usage

```
Usage: dstat_plot.rb [options] -c CATEGORY -f FIELD [directory | file1 file2 ...]
    -v, --verbose                    Output more information
    -i, --invert [VALUE]             Invert the graph such that inverted(x) = VALUE - f(x),
                                     default is 100.
    -n, --no-key                     No plot key is printed.
    -d, --dry                        Dry run. Plot is not saved to file but instead displayed with gnuplot.
    -o, --output FILE|DIR            File or Directory that plot should be saved to.
                                     If a directory is given the filename will be generated.
                                     Default is csv file directory.
    -y, --y-range RANGE              Sets the y-axis range. Default is 105. If a value exceeds
                                     this range, "autoscale" is enabled.
    -c, --category CATEGORY          Select the category.
    -f, --field FIELD                Select the field.
    -h, --help                       Display this screen.
```

(-c CATEGORY and -f FIELD are mandatory parameters)

The plot is saved as category-field.png in the folder where the csv files are located unless -o PATH explicitly specifies a different destination.

### Example

```
ruby dstat_plot.rb -c "total cpu usage" -f "usr" example.csv
```
![example plot](http://i.imgur.com/Gfo5rfH.png)

### Possible category - field combinations

(N is the cpu core index for 0..n cores)

Categoriy | Field | |   | Categoriy | Field |
----------|-------| |---| ----------|-------|
epoch     | epoch |0|   | net/total | recv |23|
memory usage | used |1| |           | send |24|
          | buff  |2|   | net/eth0  | recv |25|
          | cach  |3|   |           | send |26|
          | free  |4|   | dsk/total | read |27|
swap      | used  |5|   |           | writ |28|
          |free   |6|   | dsk/sda   | read |29|
system    | int   |7|   |           | writ |30|
          |csv    |8|   | io/total  | read |31|
paging    | in    |9|   |           | writ |32|
          |out    |10|   | io/sda    | read |33|
total cpu usage   | usr | 11| |       | writ |34|
          | sys   |12|
          | idl   |13|
          | wai   |14|
          | hiq   |15|
          | siq   |16|
cpuN usage | usr  |17|
          | sys   |18|
          | idl   |19|
          | wai   |20|
          | hiq   |21|
          | siq   |22|